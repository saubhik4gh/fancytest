name: Create PR for latest sync branch

on:
  workflow_dispatch:

jobs:
  create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Find latest sync branch
        id: find_branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Finding latest sync-* branch..."

          BRANCH=$(gh api repos/saubhik4gh/fancytest/branches \
            --jq '.[] | select(.name | startswith("sync-")) | .name' \
            | sort -r \
            | head -n 1)

          if [ -z "$BRANCH" ]; then
            echo "‚ùå No sync-* branch found"
            exit 1
          fi

          echo "Using branch: $BRANCH"
          echo "SYNC_BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Ensure branch has commits vs main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/saubhik4gh/fancytest/compare/main...${SYNC_BRANCH} \
            --jq '.ahead_by' | grep -q '[1-9]' \
            || { echo "‚ùå No commits between main and ${SYNC_BRANCH}"; exit 1; }

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --repo saubhik4gh/fancytest \
            --head saubhik4gh:${SYNC_BRANCH} \
            --base main \
            --title "Sync cloud release logs (${SYNC_BRANCH})" \
            --body "üîÑ Automated PR from latest sync branch"
